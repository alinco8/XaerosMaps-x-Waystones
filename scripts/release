#!/usr/bin/env bash
# Requires: git, git-cliff, gum, gh, gradle
set -euo pipefail

fatal() {
  gum log -l fatal "$1"
  exit 1
}
info() {
  gum log -l info "$1"
}

need() {
  for cmd in "$@"; do
    command -v "$cmd" >/dev/null 2>&1 || fatal "Missing dependency: $cmd"
  done
}

if_prod() {
  if [[ "${DRY_RUN:-}" == "false" ]]; then
    "$@"
  fi
}

need git git-cliff gum gh sed grep cut tr mktemp

git rev-parse --is-inside-work-tree >/dev/null 2>&1 || fatal "Not a git repository."

if [[ -n "$(git status --porcelain)" ]]; then
  git status --porcelain | sed 's/^/  /' >&2 || true
  fatal "Working directory is dirty. Please commit or stash changes before releasing."
fi

BRANCH="$(git branch --show-current)"
[[ -n "$BRANCH" ]] || fatal "Detached HEAD. Please checkout a branch before releasing."

git rev-parse --abbrev-ref --symbolic-full-name "@{u}" >/dev/null 2>&1 \
  || fatal "No upstream set for '$BRANCH'. Set upstream before releasing."

git fetch --tags >/dev/null 2>&1 || fatal "Failed to fetch tags."

if [[ "$(git rev-list --count "@{u}..HEAD")" != "0" ]]; then
  fatal "You have unpushed commits. Push before releasing."
fi
if [[ "$(git rev-list --count "HEAD..@{u}")" != "0" ]]; then
  fatal "Remote has new commits. Pull/rebase before releasing."
fi

CURRENT_VERSION="$(grep -E '^mod\.version=' gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')"
[[ -n "$CURRENT_VERSION" ]] || fatal "Could not read current version from gradle.properties."

NEXT_VERSION="$(git-cliff --unreleased --bumped-version | tr -d '[:space:]')"
NEXT_VERSION="${NEXT_VERSION#v}"
[[ -n "$NEXT_VERSION" ]] || fatal "git-cliff did not produce a bumped version."

if [[ "$CURRENT_VERSION" == "$NEXT_VERSION" ]]; then
  fatal "No new version detected. Current version is already $CURRENT_VERSION."
fi

git rev-parse "v$NEXT_VERSION" >/dev/null 2>&1 && fatal "Tag v$NEXT_VERSION already exists."

[[ -n "${MODRINTH_TOKEN:-}" ]] || fatal "MODRINTH_TOKEN environment variable is not set (or empty)."
[[ -n "${CURSEFORGE_TOKEN:-}" ]] || fatal "CURSEFORGE_TOKEN environment variable is not set (or empty)."

RELEASE_NOTES="$(git-cliff --unreleased --strip all)"
[[ -n "$RELEASE_NOTES" ]] || fatal "Release notes are empty."

info "Releasing... $CURRENT_VERSION -> $NEXT_VERSION"
info "Release notes:"
info "$RELEASE_NOTES"

cleanup() {
  if [[ -n "$(git status --porcelain)" ]]; then
    git restore --source=HEAD --staged --worktree gradle.properties >/dev/null 2>&1 || true
  fi
}
trap cleanup ERR INT

sed -i '' -E "s/^mod\.version=.*/mod.version=$NEXT_VERSION/" gradle.properties
info "Updated gradle.properties with new version."

info "Committing version bump..."
git add gradle.properties
git commit -m "chore(release): v$NEXT_VERSION"
git tag "v$NEXT_VERSION"

info "Building & publishing..."
rm -f build/libs/* || true
CHANGELOG=$RELEASE_NOTES ./gradlew buildAndCollect publishMods --warning-mode all

tmp_notes="$(mktemp)"
printf '%s\n' "$RELEASE_NOTES" > "$tmp_notes"

info "Pushing the following commits and tag to origin:"
COMMITS="$(git rev-list --no-merges --pretty=oneline "v$CURRENT_VERSION..HEAD" | grep -v "^commit ")"
info "$COMMITS"

gum confirm "Push release to origin?" || fatal "Release aborted by user."

if_prod git push origin "$BRANCH" "v$NEXT_VERSION"
if_prod gh release create "v$NEXT_VERSION" -F "$tmp_notes" build/libs/*

rm -f "$tmp_notes"

info "Done!"
